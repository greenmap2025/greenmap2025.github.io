<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°¸çºŒäº¤æµå° (é€£ç·šç‰ˆ)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- 1. å…¨åŸŸæ¨£å¼ (è·Ÿé¦–é ã€åœ°åœ–å®Œå…¨çµ±ä¸€) --- */
        :root {
            --primary: #43A047; --secondary: #2E7D32; 
            --text: #1c1e21; --text-light: #65676b;
            --shadow: 0 8px 30px rgba(0,0,0,0.1);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: var(--text);
            min-height: 100vh;
            position: relative;
        }
        body::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="%2343A047"/><circle cx="80" cy="30" r="1.5" fill="%2369f0ae"/><circle cx="50" cy="70" r="2" fill="%238bc34a"/></svg>') repeat;
            opacity: 0.1; pointer-events: none; z-index: -1;
        }
        
        /* --- 2. å°è¦½åˆ— --- */
        nav { 
            background: rgba(27, 94, 32, 0.95); 
            backdrop-filter: blur(10px); 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); 
            position: sticky; top: 0; z-index: 1000; 
        }
        .nav-inner { max-width: 1200px; margin: 0 auto; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.6rem; font-weight: bold; color: white; text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .logo i { color: #8bc34a; animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        
        .nav-links { display: flex; gap: 10px; }
        .nav-links a { color: white; text-decoration: none; font-weight: 500; padding: 0.5rem 1.2rem; border-radius: 50px; transition: 0.3s; display: flex; align-items: center; gap: 6px; font-size: 0.95rem; }
        .nav-links a:hover, .nav-links a.active { background: #43A047; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        @media(max-width:768px) { 
            .nav-inner { flex-direction: column; gap: 10px; padding: 0.8rem 1rem; } 
            .nav-links a span { display: none; } 
        }

        /* --- 3. äº¤æµå°æ¨£å¼ --- */
        .container { max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
        
        .card, .post-card { 
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 20px; 
            box-shadow: var(--shadow); 
            padding: 1.5rem; 
            margin-bottom: 1.5rem; 
        }
        
        .user-profile { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .avatar-preview { width: 50px; height: 50px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; box-shadow: 0 4px 10px rgba(67,160,71,0.3); }
        .user-input-group { flex: 1; display: flex; gap: 10px; }
        .user-input-group input { flex: 1; padding: 8px 15px; border: 2px solid transparent; background: rgba(255,255,255,0.8); border-radius: 20px; outline: none; transition: 0.3s; }
        .user-input-group input:focus { border-color: var(--primary); background: white; }
        .btn-small { background: #757575; color: white; border: none; padding: 5px 15px; border-radius: 20px; cursor: pointer; transition:0.2s; }

        .create-post h3 { color: var(--secondary); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; font-weight:700; }
        .tag-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .tag-option { padding: 6px 14px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; border: 1px solid #ccc; color: #666; transition: 0.2s; background: rgba(255,255,255,0.5); }
        .tag-option:hover { transform: translateY(-2px); }
        .tag-option.selected { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(67,160,71,0.3); }
        
        .post-input-area { width: 100%; border: 2px solid transparent; background: rgba(255,255,255,0.8); padding: 15px; border-radius: 15px; font-size: 1rem; resize: none; outline: none; margin-bottom: 15px; font-family: inherit; transition:0.3s; }
        .post-input-area:focus { background: white; border-color: var(--primary); }
        
        .btn-post { background: linear-gradient(45deg, #43A047, #66bb6a); color: white; border: none; padding: 12px 30px; border-radius: 50px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1rem; transition: 0.2s; box-shadow: 0 4px 15px rgba(67,160,71,0.3); }
        .btn-post:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(67,160,71,0.4); }

        .post-card { overflow: hidden; animation: fadeIn 0.5s ease; padding: 0; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
        
        .post-header { padding: 20px; display: flex; align-items: center; gap: 12px; }
        .post-avatar { width: 42px; height: 42px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .post-info h4 { font-size: 1.05rem; margin-bottom: 3px; color: #2e7d32; }
        .post-info span { font-size: 0.8rem; color: #888; }
        .post-tag { margin-left: auto; font-size: 0.8rem; padding: 5px 12px; border-radius: 20px; background: #e8f5e9; color: var(--secondary); font-weight: 600; }
        
        .post-content { padding: 0 20px 20px 20px; font-size: 1.1rem; line-height: 1.7; color: #333; }
        
        .post-actions { border-top: 1px solid rgba(0,0,0,0.05); padding: 12px 20px; display: flex; gap: 20px; background: rgba(255,255,255,0.3); }
        .action-btn { background: none; border: none; color: #666; font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: 0.2s; font-family: inherit; }
        .action-btn:hover { color: var(--primary); }
        .action-btn.liked { color: #e74c3c; }

        .comments-section { background: rgba(245, 245, 245, 0.6); padding: 15px 20px; display: none; }
        .comments-section.show { display: block; }
        .comment { display: flex; gap: 10px; margin-bottom: 12px; }
        .comment-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: white; flex-shrink:0; }
        .comment-bubble { background: white; padding: 10px 15px; border-radius: 18px; font-size: 0.95rem; flex: 1; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .comment-user { font-weight: bold; font-size: 0.85rem; margin-bottom: 4px; display: block; color: var(--secondary); }
        .comment-input-box { display: flex; gap: 10px; margin-top: 15px; }
        .comment-input-box input { flex: 1; padding: 10px 15px; border: 1px solid #ddd; border-radius: 25px; outline: none; }
        
        .empty-state { text-align: center; color: #666; padding: 40px; font-size: 1.1rem; }
    </style>
</head>
<body>

<nav>
    <div class="nav-inner">
        <a href="index.html" class="logo"><i class="fas fa-leaf"></i> æ°¸çºŒæ¶ˆè²»åœ°åœ–</a>
        <div class="nav-links">
            <a href="index.html"><i class="fas fa-home"></i> é¦–é </a>
            <a href="map.html"><i class="fas fa-map-marked-alt"></i> æ¢ç´¢åœ°åœ–</a>
            <a href="forum.html" class="active"><i class="fas fa-comments"></i> äº¤æµå°</a>
        </div>
    </div>
</nav>

<div class="container">
    <div class="card">
        <div class="user-profile">
            <div class="avatar-preview" id="myAvatar">è¨ª</div>
            <div class="user-input-group">
                <input type="text" id="usernameInput" placeholder="è¨­å®šä½ çš„æš±ç¨±" maxlength="10">
                <button class="btn-small" onclick="saveUsername()">å„²å­˜</button>
            </div>
        </div>

        <div class="create-post">
            <h3><i class="fas fa-pen-fancy"></i> å»ºç«‹è²¼æ–‡</h3>
            <div class="tag-selector">
                <div class="tag-option selected" onclick="selectTag(this, 'å¿ƒå¾—')">ğŸŒ± å¿ƒå¾—åˆ†äº«</div>
                <div class="tag-option" onclick="selectTag(this, 'æ¨è–¦')">ğŸ‘ å¥½åº—æ¨è–¦</div>
                <div class="tag-option" onclick="selectTag(this, 'æå•')">â“ æ°¸çºŒæå•</div>
            </div>
            <textarea id="postContent" class="post-input-area" rows="3" placeholder="åœ¨æƒ³ä»€éº¼ï¼Ÿåˆ†äº«ä½ çš„æ°¸çºŒç”Ÿæ´»ç™¼ç¾..."></textarea>
            <button class="btn-post" id="submitBtn">ç™¼å¸ƒè²¼æ–‡</button>
        </div>
    </div>

    <div id="feedArea">
        <div class="empty-state"><i class="fas fa-spinner fa-spin"></i> æ­£åœ¨é€£ç·šåˆ°é›²ç«¯è³‡æ–™åº«...</div>
    </div>
</div>

<script type="module">
    // âš ï¸ ä¿®å¾©é‡é» 1: ä½¿ç”¨ç©©å®šçš„ 10.12.0 ç‰ˆæœ¬ï¼Œç¢ºä¿ CDN å¯ç”¨
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    // âš ï¸ ä¿®å¾©é‡é» 2: è£œä¸Š firestore æ¨¡çµ„ï¼Œé€™æ¨£æ‰èƒ½å­˜å–è³‡æ–™åº«
    import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, arrayUnion, orderBy, query, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // âš ï¸ ä¿®å¾©é‡é» 3: å¡«å…¥ä½ å‰›å‰›çµ¦çš„æ­£ç¢º Config (åŒ…å« measurementId)
    const firebaseConfig = {
      apiKey: "AIzaSyDFfPxs5gXDcjLxQGGCQUm_aaNdXc6pdto",
      authDomain: "greenmap2025-e0c58.firebaseapp.com",
      projectId: "greenmap2025-e0c58",
      storageBucket: "greenmap2025-e0c58.firebasestorage.app",
      messagingSenderId: "712824475160",
      appId: "1:712824475160:web:a65b951094e50f3a3f3d6d",
      measurementId: "G-RS4PXF9V7P"
    };
  
    // åˆå§‹åŒ– Firebase èˆ‡ Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
  
    // --- ç¨‹å¼é‚è¼¯é–‹å§‹ ---
    let currentUser = localStorage.getItem('forum_user') || 'è¨ªå®¢';
    let currentTag = 'å¿ƒå¾—';
    
    // åˆå§‹åŒ– UI
    const nameInput = document.getElementById('usernameInput');
    nameInput.value = currentUser;
    updateAvatarUI(currentUser);

    // å…¨åŸŸè®Šæ•¸æ–¹ä¾¿ HTML onclick å‘¼å«
    window.saveUsername = function() {
        const name = nameInput.value.trim();
        if(!name) return alert("è«‹è¼¸å…¥æš±ç¨±ï¼");
        currentUser = name;
        localStorage.setItem('forum_user', name);
        updateAvatarUI(name);
        alert("æš±ç¨±å·²æ›´æ–°ç‚ºï¼š" + name);
    }

    window.selectTag = function(el, tag) {
        document.querySelectorAll('.tag-option').forEach(d => d.classList.remove('selected'));
        el.classList.add('selected');
        currentTag = tag;
    }

    function updateAvatarUI(name) {
        const avatar = document.getElementById('myAvatar');
        avatar.innerText = name[0];
        avatar.style.backgroundColor = stringToColor(name);
    }

    function stringToColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); }
        const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
        return '#' + "00000".substring(0, 6 - c.length) + c;
    }

    // ç™¼å¸ƒè²¼æ–‡
    document.getElementById('submitBtn').addEventListener('click', async () => {
        const content = document.getElementById('postContent').value.trim();
        if(!content) return alert("å…§å®¹ä¸èƒ½ç‚ºç©ºå–”ï¼");

        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = "ç™¼å¸ƒä¸­...";

        try {
            await addDoc(collection(db, "posts"), {
                user: currentUser,
                content: content,
                tag: currentTag,
                timestamp: Date.now(),
                timeStr: new Date().toLocaleString('zh-TW', { month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit' }),
                likes: 0,
                comments: []
            });
            document.getElementById('postContent').value = "";
        } catch (e) {
            console.error("Error adding document: ", e);
            alert("ç™¼é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ï¼(æˆ–ç¢ºèª Firebase Firestore æœ‰é–‹å•Ÿ Test Mode)");
        }
        btn.disabled = false;
        btn.innerText = "ç™¼å¸ƒè²¼æ–‡";
    });

    // å³æ™‚ç›£è½è³‡æ–™åº«
    const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
    
    onSnapshot(q, (snapshot) => {
        const feed = document.getElementById('feedArea');
        feed.innerHTML = "";

        if(snapshot.empty) {
            feed.innerHTML = `<div class="empty-state">ç›®å‰é‚„æ²’æœ‰è²¼æ–‡ï¼Œå¿«ä¾†æ¶é ­é¦™ï¼</div>`;
            return;
        }

        snapshot.forEach((docSnap) => {
            const post = docSnap.data();
            const pid = docSnap.id; 
            
            const avatarColor = stringToColor(post.user);
            const myLikes = JSON.parse(localStorage.getItem('my_likes') || '[]');
            const isLiked = myLikes.includes(pid);
            const likeClass = isLiked ? 'liked' : '';

            let commentsHtml = "";
            if(post.comments && post.comments.length > 0) {
                commentsHtml = post.comments.map(c => `
                    <div class="comment">
                        <div class="comment-avatar" style="background:${stringToColor(c.user)}">${c.user[0]}</div>
                        <div class="comment-bubble">
                            <span class="comment-user">${c.user}</span>
                            ${c.content}
                        </div>
                    </div>
                `).join('');
            }

            const html = `
                <div class="post-card">
                    <div class="post-header">
                        <div class="post-avatar" style="background:${avatarColor}">${post.user[0]}</div>
                        <div class="post-info">
                            <h4>${post.user}</h4>
                            <span>${post.timeStr}</span>
                        </div>
                        <span class="post-tag"># ${post.tag}</span>
                    </div>
                    <div class="post-content">
                        ${post.content.replace(/\n/g, '<br>')}
                    </div>
                    <div class="post-actions">
                        <button class="action-btn ${likeClass}" onclick="toggleLike('${pid}', ${post.likes})">
                            <i class="fas fa-heart"></i> ${post.likes}
                        </button>
                        <button class="action-btn" onclick="toggleComment('${pid}')">
                            <i class="fas fa-comment-alt"></i> ${post.comments ? post.comments.length : 0} ç•™è¨€
                        </button>
                        <button class="action-btn" onclick="deletePost('${pid}', '${post.user}')" style="margin-left:auto; color:#bbb;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <div class="comments-section" id="comment-box-${pid}">
                        <div id="comment-list-${pid}">${commentsHtml}</div>
                        <div class="comment-input-box">
                            <input type="text" id="input-${pid}" placeholder="ç•™è¨€...">
                            <button class="btn-small" style="background:var(--primary)" onclick="addComment('${pid}')">é€å‡º</button>
                        </div>
                    </div>
                </div>
            `;
            feed.innerHTML += html;
        });
    });

    // äº’å‹•åŠŸèƒ½
    window.toggleLike = async function(pid, currentLikes) {
        let myLikes = JSON.parse(localStorage.getItem('my_likes') || '[]');
        const ref = doc(db, "posts", pid);
        if(myLikes.includes(pid)) {
            await updateDoc(ref, { likes: currentLikes - 1 });
            myLikes = myLikes.filter(id => id !== pid);
        } else {
            await updateDoc(ref, { likes: currentLikes + 1 });
            myLikes.push(pid);
        }
        localStorage.setItem('my_likes', JSON.stringify(myLikes));
    }

    window.addComment = async function(pid) {
        const input = document.getElementById(`input-${pid}`);
        const val = input.value.trim();
        if(!val) return;
        const ref = doc(db, "posts", pid);
        try {
            await updateDoc(ref, {
                comments: arrayUnion({ user: currentUser, content: val, time: Date.now() })
            });
            input.value = ""; 
        } catch(e) { console.error(e); }
    }

    window.toggleComment = function(pid) {
        document.getElementById(`comment-box-${pid}`).classList.toggle('show');
    }

    window.deletePost = async function(pid, author) {
        if(!confirm(`ç¢ºå®šè¦åˆªé™¤é€™ç¯‡è²¼æ–‡å—ï¼Ÿ`)) return;
        try { await deleteDoc(doc(db, "posts", pid)); } catch(e) { alert("åˆªé™¤å¤±æ•—"); }
    }
</script>

</body>
</html>
