<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>æ°¸çºŒæ¶ˆè²»åœ°åœ–ï½œæ¢ç´¢</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- å…¨åŸŸè¨­å®š (åŒæ­¥é¦–é é¢¨æ ¼) --- */
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            /* èƒŒæ™¯è·Ÿé¦–é ä¸€æ¨£çš„æ¼¸å±¤ç¶  */
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: #333;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* å›ºå®šè¦–çª—ï¼Œè®“å…§éƒ¨æ²å‹• */
            position: relative;
        }
        /* èƒŒæ™¯ç´‹ç† (è·Ÿé¦–é ä¸€æ¨£) */
        body::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="%2343A047"/><circle cx="80" cy="30" r="1.5" fill="%2369f0ae"/><circle cx="50" cy="70" r="2" fill="%238bc34a"/></svg>') repeat;
            opacity: 0.1; pointer-events: none; z-index: -1;
        }
        
        /* --- å°è¦½åˆ— (å®Œå…¨è¤‡è£½é¦–é æ¨£å¼) --- */
        nav {
            background: rgba(27, 94, 32, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 1001;
            width: 100%;
            flex-shrink: 0;
        }
        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.6rem;
            font-weight: bold;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }
        .logo i { color: #8bc34a; animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        
        .nav-links { display: flex; gap: 10px; }
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1.2rem;
            border-radius: 50px;
            transition: 0.3s;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .nav-links a:hover, .nav-links a.active {
            background: #43A047;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* --- ä½ˆå±€å®¹å™¨ (Desktop: å·¦åˆ—è¡¨/å³åœ°åœ–) --- */
        .main-wrapper {
            display: flex;
            flex: 1; /* å¡«æ»¿å‰©é¤˜é«˜åº¦ */
            height: calc(100vh - 80px); /* æ‰£æ‰å°è¦½åˆ—é«˜åº¦ */
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            padding: 20px;
            gap: 20px;
        }

        /* --- å·¦å´ï¼šåˆ—è¡¨å€ (ç»ç’ƒæ“¬æ…‹å¡ç‰‡) --- */
        .sidebar {
            width: 420px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden; /* åœ“è§’ä¸è¢«åˆ‡æ‰ */
            border: 1px solid rgba(255,255,255,0.5);
        }

        /* æ§åˆ¶å€ (æœå°‹ & ç¯©é¸) */
        .controls {
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .search-box { position: relative; margin-bottom: 15px; }
        .search-box input {
            width: 100%; padding: 12px 15px 12px 40px;
            border: 2px solid transparent; border-radius: 12px;
            background: #fff; font-size: 1rem; outline: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transition: 0.3s;
        }
        .search-box input:focus { border-color: #43A047; box-shadow: 0 4px 15px rgba(67,160,71,0.2); }
        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #43A047; }
        
        .filter-row { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .filter-row::-webkit-scrollbar { height: 4px; } /* éš±è—æ²è»¸ */
        .filter-row::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        
        select {
            padding: 8px 15px; border: 1px solid #ddd; border-radius: 20px;
            background: white; font-size: 0.9rem; color: #333; outline: none; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        select:hover { border-color: #43A047; }
        
        .btn-fav {
            padding: 8px 18px; background: white; border: 1px solid #ddd; border-radius: 20px;
            font-size: 0.9rem; cursor: pointer; color: #555; white-space: nowrap; display: flex; align-items: center; gap: 6px;
            transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .btn-fav.active { background: #ffebee; color: #e91e63; border-color: #e91e63; }
        .btn-fav:hover { transform: translateY(-1px); }

        /* åº—å®¶åˆ—è¡¨ (æ²å‹•å€) */
        .store-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            /* è®“æ²è»¸æ¼‚äº®ä¸€é» */
            scrollbar-width: thin;
            scrollbar-color: #8bc34a transparent;
        }
        .store-list::-webkit-scrollbar { width: 6px; }
        .store-list::-webkit-scrollbar-track { background: transparent; }
        .store-list::-webkit-scrollbar-thumb { background-color: #8bc34a; border-radius: 20px; }

        /* åº—å®¶å°å¡ç‰‡ */
        .store-item {
            background: white; padding: 18px; border-radius: 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            cursor: pointer; transition: all 0.25s ease;
            position: relative; border: 1px solid #f0f0f0;
        }
        .store-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.08);
            border-color: #43A047;
        }
        
        .store-name { font-weight: 700; color: #1B5E20; font-size: 1.1rem; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
        .store-tag { font-size: 0.75rem; background: #e8f5e9; color: #2e7d32; padding: 4px 10px; border-radius: 20px; font-weight: 600; }
        .store-addr { font-size: 0.9rem; color: #666; margin-bottom: 8px; display: flex; align-items: flex-start; gap: 6px; }
        .store-desc { font-size: 0.9rem; color: #444; line-height: 1.5; border-top: 1px dashed #eee; padding-top: 10px; margin-top: 10px; }
        
        .heart-icon { font-size: 1.3rem; color: #ddd; cursor: pointer; transition: 0.2s; padding: 5px; }
        .heart-icon.active { color: #e91e63; transform: scale(1.1); text-shadow: 0 2px 5px rgba(233,30,99,0.3); }
        .heart-icon:hover { color: #ff80ab; }

        /* --- å³å´ï¼šåœ°åœ–å€ --- */
        .map-wrapper {
            flex: 1;
            position: relative;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 4px solid white; /* ç™½æ¡†è³ªæ„Ÿ */
        }
        iframe { width: 100%; height: 100%; border: 0; }
        .loading { text-align: center; padding: 40px; color: #888; font-size: 1rem; }

        /* --- ğŸ“± æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼è¨­è¨ˆ (App æ¨¡å¼) --- */
        @media (max-width: 900px) {
            /* èª¿æ•´å°è¦½åˆ— */
            .nav-inner { padding: 0.8rem 1rem; }
            .nav-links a span { display: none; } /* æ‰‹æ©Ÿéš±è—æ–‡å­—åªç•™ icon */
            
            /* App ä½ˆå±€ï¼šåœ°åœ–åœ¨ä¸Šï¼Œåˆ—è¡¨åœ¨ä¸‹ */
            .main-wrapper {
                flex-direction: column;
                padding: 0; /* æ‰‹æ©Ÿç‰ˆä¸éœ€è¦å¤–è· */
                height: calc(100vh - 60px);
                gap: 0;
            }

            /* åœ°åœ–å€åŸŸ (ä¸Šæ–¹ 40%) */
            .map-wrapper {
                height: 40vh;
                flex: none;
                border-radius: 0;
                border: none;
                box-shadow: none;
                z-index: 1;
            }

            /* åˆ—è¡¨å€åŸŸ (ä¸‹æ–¹ 60% - æ»‘å‹•å¼å¡ç‰‡) */
            .sidebar {
                width: 100%;
                flex: 1;
                border-radius: 24px 24px 0 0; /* ä¸Šæ–¹åœ“è§’ */
                margin-top: -20px; /* ç¨å¾®è“‹ä½åœ°åœ–ï¼Œè£½é€ å±¤æ¬¡æ„Ÿ */
                z-index: 2;
                box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
                background: #fff; /* æ‰‹æ©Ÿç‰ˆæ”¹å›ç´”ç™½åº•æ¯”è¼ƒæ¸…æ¥š */
                border: none;
            }
            
            .controls { padding: 15px; }
            .store-item { padding: 15px; margin-bottom: 10px; }
        }
    </style>
</head>
<body>

    <nav>
        <div class="nav-inner">
            <a href="index.html" class="logo"><i class="fas fa-leaf"></i> æ°¸çºŒæ¶ˆè²»åœ°åœ–</a>
            <div class="nav-links">
                <a href="index.html"><i class="fas fa-home"></i> <span>é¦–é </span></a>
                <a href="map.html" class="active"><i class="fas fa-map-marked-alt"></i> <span>æ¢ç´¢åœ°åœ–</span></a>
                <a href="forum.html"><i class="fas fa-comments"></i> <span>äº¤æµå°</span></a>
            </div>
        </div>
    </nav>

    <div class="main-wrapper">
        
        <div class="sidebar">
            <div class="controls">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="æœå°‹åº—å®¶ã€åœ°å€æˆ–ç‰¹è‰²..." onkeyup="filterStores()">
                </div>
                <div class="filter-row">
                    <select id="citySelect" onchange="switchCity(this.value)">
                        <option value="æ–°åŒ—">ğŸ“ æ–°åŒ—å¸‚</option>
                        <option value="å°åŒ—">ğŸ“ å°åŒ—å¸‚</option>
                    </select>
                    <select id="districtSelect" onchange="switchDistrict(this.value)">
                        <option value="å…¨éƒ¨">ğŸ  å…¨éƒ¨å€åŸŸ</option>
                    </select>
                    <button class="btn-fav" id="favFilterBtn" onclick="toggleShowFavorites()">
                        <i class="far fa-heart" id="favFilterIcon"></i> æˆ‘çš„æ”¶è—
                    </button>
                </div>
            </div>
            
            <div class="store-list" id="storeList">
                <div class="loading"><i class="fas fa-circle-notch fa-spin"></i> æ­£åœ¨å°‹æ‰¾ç¶ è‰²åº—å®¶...</div>
            </div>
        </div>

        <div class="map-wrapper">
            <iframe id="map-iframe" src="https://www.google.com/maps/d/embed?mid=1RVjjiUNbpJe9YEcP2Gxj9OpDNMYVVVQ&ehbc=2E312F" allowfullscreen loading="lazy"></iframe>
        </div>
    </div>

<script>
    // --- è³‡æ–™èˆ‡é‚è¼¯ ---
    const SHEET_ID = '1uu_D_9cqpv80o8QpCQmzByiilTzU1BKyKnPi5cFjMzA';
    const CITY_SHEETS = { 'æ–°åŒ—': 'ç’°ä¿é¤å»³-æ–°åŒ—', 'å°åŒ—': 'å°åŒ—' };
    const MAP_URLS = {
        'æ–°åŒ—': 'https://www.google.com/maps/d/embed?mid=1RVjjiUNbpJe9YEcP2Gxj9OpDNMYVVVQ&ehbc=2E312F',
        'å°åŒ—': 'https://www.google.com/maps/d/embed?mid=1n6Kw17wazzDD76EZPZXKUebU2hB8XkU&ehbc=2E312F'
    };

    let allStores = [];
    let currentData = [];
    let currentCity = 'æ–°åŒ—';
    let isFavMode = false;

    // å•Ÿå‹•æ™‚åŸ·è¡Œ
    loadStores(currentCity);

    // 1. è®€å– Google Sheets
    async function loadStores(city) {
        document.getElementById('storeList').innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> è³‡æ–™è¼‰å…¥ä¸­...</div>';
        
        const sheetName = CITY_SHEETS[city];
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;

        try {
            const res = await fetch(url);
            const text = await res.text();
            
            const rows = text.split('\n').slice(1);
            allStores = rows.map(row => {
                const cols = parseCSV(row);
                return {
                    name: cols[0] || 'æœªçŸ¥åº—å®¶',
                    address: cols[1] || 'ç„¡åœ°å€',
                    district: (cols[2] || '').trim().replace(/å€$/g, '') + 'å€',
                    desc: cols[3] || 'å°šç„¡ä»‹ç´¹',
                    city: city
                };
            }).filter(s => s.name.trim() !== '');

            currentData = allStores;
            updateDistrictSelect();
            renderList();

        } catch (err) {
            console.error(err);
            document.getElementById('storeList').innerHTML = '<div class="loading">è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é€£çµã€‚</div>';
        }
    }

    // 2. æ¸²æŸ“åˆ—è¡¨
    function renderList() {
        const listEl = document.getElementById('storeList');
        const favs = getFavs();
        
        let displayData = currentData;
        if (isFavMode) {
            displayData = displayData.filter(s => favs.includes(s.name));
        }

        if (displayData.length === 0) {
            listEl.innerHTML = '<div class="loading">æ²’æœ‰ç¬¦åˆçš„åº—å®¶ ğŸƒ</div>';
            return;
        }

        listEl.innerHTML = displayData.map(store => {
            const isFav = favs.includes(store.name);
            return `
            <div class="store-item" onclick="openMap('${store.name}', '${store.address}')">
                <div class="store-name">
                    ${store.name}
                    <i class="${isFav ? 'fas' : 'far'} fa-heart heart-icon ${isFav ? 'active' : ''}" 
                       onclick="toggleFav(event, '${store.name}')"></i>
                </div>
                <div class="store-addr">
                    <span class="store-tag">${store.district}</span>
                    <span><i class="fas fa-map-marker-alt" style="color:#e53935;"></i> ${store.address}</span>
                </div>
                <div class="store-desc">${store.desc}</div>
            </div>
            `;
        }).join('');
    }

    // 3. äº’å‹•åŠŸèƒ½
    function switchCity(city) {
        currentCity = city;
        document.getElementById('map-iframe').src = MAP_URLS[city];
        loadStores(city);
    }

    function switchDistrict(dist) {
        if(dist === 'å…¨éƒ¨') {
            currentData = allStores;
        } else {
            currentData = allStores.filter(s => s.district === dist);
        }
        renderList();
    }

    function filterStores() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        currentData = allStores.filter(s => 
            s.name.toLowerCase().includes(q) || 
            s.address.toLowerCase().includes(q) ||
            s.desc.toLowerCase().includes(q)
        );
        renderList();
    }

    function updateDistrictSelect() {
        const districts = [...new Set(allStores.map(s => s.district))].sort();
        const sel = document.getElementById('districtSelect');
        sel.innerHTML = '<option value="å…¨éƒ¨">ğŸ  å…¨éƒ¨å€åŸŸ</option>' + 
                        districts.map(d => `<option value="${d}">${d}</option>`).join('');
    }

    // æ”¶è—åŠŸèƒ½
    function getFavs() { return JSON.parse(localStorage.getItem('myFavs') || '[]'); }
    function toggleFav(e, name) {
        e.stopPropagation();
        let favs = getFavs();
        if(favs.includes(name)) {
            favs = favs.filter(n => n !== name);
        } else {
            favs.push(name);
        }
        localStorage.setItem('myFavs', JSON.stringify(favs));
        renderList();
    }
    function toggleShowFavorites() {
        isFavMode = !isFavMode;
        const btn = document.getElementById('favFilterBtn');
        const icon = document.getElementById('favFilterIcon');
        
        if(isFavMode) {
            btn.classList.add('active');
            icon.classList.remove('far');
            icon.classList.add('fas');
            btn.innerHTML = `<i class="fas fa-heart"></i> é¡¯ç¤ºå…¨éƒ¨`;
        } else {
            btn.classList.remove('active');
            icon.classList.remove('fas');
            icon.classList.add('far');
            btn.innerHTML = `<i class="far fa-heart"></i> æˆ‘çš„æ”¶è—`;
        }
        renderList();
    }

    // åœ°åœ–è·³è½‰
    function openMap(name, addr) {
        const q = encodeURIComponent(`å°ç£ ${addr}`);
        window.open(`https://www.google.com/maps/search/?api=1&query=${q}`, '_blank');
    }

    // CSV è§£æ
    function parseCSV(line) {
        const res = [];
        let cur = '';
        let inQuote = false;
        for(let c of line) {
            if(c === '"') { inQuote = !inQuote; }
            else if(c === ',' && !inQuote) { res.push(cur); cur = ''; }
            else { cur += c; }
        }
        res.push(cur);
        return res.map(s => s.trim().replace(/^"|"$/g, ''));
    }
</script>

</body>
</html>
